{% extends "base.html" %}
    {% block title %}
        Backup Storage
    {% endblock %}
    {% block head %}
    {{ super() }}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/backup_storage.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.bootstrap5.css') }}">
        <script src="{{ url_for('static', filename='js/jquery/jquery-3.0.6.min.js') }}"></script>
<!--    <script src="{{ url_for('static', filename='js/bootstrap/bootstrap.bundle.min.js') }}"></script> -->
        <script src="{{ url_for('static', filename='js/datatables/jquery.dataTables.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/datatables/dataTables.bootstrap5.min.js') }}"></script>
    {% endblock %}
{% block content %}
    <div class="container">
        <section class="table-section">
        <h2>Backup Storage Management</h2>
        <button class="info-button" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions" title="About this page">
                <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Info:"><use href="#info-fill"/></svg>
            </button>
        <h4>This page allows you to manage and clean up uploads folders.</h4>
        </section>

    {% if folder_contents %}
    <section class="generated-folders-section" id="generated-folders-section">
        <div class="table-folders table-responsive">
        <table id="files-table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Folder</th>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Created</th>
                    <th>Path</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for folder_name, files in folder_contents.items() %}
                    {% for file in files %}
                        <tr>
                            <td class="folder-td" >{{ folder_name }}</td>
                            <td class="file-name-td" data-fulltext="{{ file.name }}">{{ file.name }}</td>
                            <td class="file-size-td">{{ file.size }} MB</td>
                            <td class="file-created-td">{{ file.created }}</td>
                            <td class="file-path-td" data-fulltext="{{ file.path }}" title="{{file.path}}">
                                {{ file.path }}
                            </td>
                            <td class="file-actions-td">
                                <a href="/uploads/{{ folder_name|lower|replace(' ', '_') }}/{{ file.name }}" title="Download {{file.name}}" class="btn btn-success">Download</a>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
        <script>
            $(document).ready(function() {
                $('#files-table').DataTable({
                    scrollY: '400px',
                    scrollCollapse: true,
                    paging: true,
                    info: true,
                    searching: true,
                    pageLength: 5,
                });
        });
        </script>
        </div>
    </section>
   <section class="cleaner-section">
    <h5>Clean folders</h5>
    <form id="clean-folders-form">
        <div class="input-group">
        <label class="input-group-text" for="inputGroupSelect01">Select folders</label>
        <select id="folder-select" name="folders" class="form-select" id="inputGroupSelect01">
            <option value="ALL">Select all</option>
            {% for folder_name in folder_contents.keys() %}
                <option value="{{ folder_name }}">{{ folder_name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-danger" style="margin-left:10px;">Clean</button>
    </form>
    </div>
</section>
<script>
    $('#clean-folders-form').on('submit', function(e) {
        e.preventDefault();
        let selected = $('#folder-select').val();
        let folders = [];
        if (selected.includes('ALL')) {
            folders = [{% for folder_name in folder_contents.keys() %}'{{ folder_name }}',{% endfor %}];
        } else {
            folders = selected;
        }
        $.ajax({
            url: '/clean_folders',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({folders: folders}),
            success: function(response) {
                $('#clean-result').html('<span style="color:green;">Success</span>');
                setTimeout(function(){ location.reload(); }, 1000);
            },
            error: function(xhr) {
                $('#clean-result').html('<span style="color:red;">Error</span>');
            }
        });
    });
</script>
    {% endif %}
{% endblock %}