{% extends 'base.html' %}
    {% block title %}
        Spectra Viewer
    {% endblock %}
    {% block head %}
    {{ super() }}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/spectra.css') }}">
        <script src="{{ url_for('static', filename='js/chunking/single_input_chunk.js') }}"></script>

    {% endblock %}
{% block content %}
{% if page=='Spectra' or page=='process_spectra' %}
    {% set tool_type = "Inspection Tool" %}
    {% set inputs = {
        "mzML": "Single mzML file, profile and centroid data and both MS Levels supported."
    } %}
    {% set outputs = {
        "None": "No output files generated."
     } %}
    {% set options = {
        "MS1 Level detected": {
            "Plots": {
                "Reference Spectrum": "The spectrum number used as a reference for plotting.",
                "Merged Reference Spectrum": "Reference spectra merged for a simplified view.",
                "Total Merged MS1 Spectra": "Shows the total number of MS1 spectra to merge for the reference view."
            },
            "Plot options": {
                "Spectrum Index": "Set the specific reference spectrum index to visualize.",
            },
        },
        "MS2 Level detected": {
            "Plots": {
                "MS1 Spectrum": "The MS1 spectrum associated with the selected MS2 spectrum.",
                "MS2 Spectrum": "The MS2 spectrum selected for visualization.",
                "MS1 and MS2 Spectra": "Overlayed view of MS1 and MS2 spectra with the normalized intensities."
            }
        }
    } %}
    {% set about = "This section allows you to upload and process a single mzML file to plot and compare the spectra of its MS levels." %}
    {% endif %} 
      <div class="container">
        <section class="form_section">
            <h2>mzML Spectra Visualizer</h2>
            <div class="about">
                <em>
                    {{ about }}
                </em>
                <hr>
            </div>
            <div id="processingOverlay">
                <div class="spinner-processing"></div>
                <div class="processing-text">Processing file, please wait...</div>
            </div>
            <!-- <button class="info-button" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions" title="About this page">
                <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Info:"><use href="#info-fill"/></svg>
            </button> -->
            <h4>Select a mzML file to inspect:</h4>
            <form action="/get_files_spectra" method="post" enctype="multipart/form-data" id="uploadForm">
                {% set accept_types = ".mzML" %}
                {% set accept_types_label = "mzML" %}
                {% include 'inputs/single_input.html' %}
                <div class="mb-3">
                    <div id="progressContainer" style="display:none;">
                        <label for="uploadProgress">Upload Progress</label>
                        <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" id="uploadProgress"></div>
                        </div>
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                {% include 'alerts/alerts.html' %}
            </form>
        {% if ms_level %}
            <h6>Current File: {{ filename }}</h6>
            <h6>MS Level detected: {{ ms_type }}</h6>
        {% endif %}
        </section>
        {% if ms_type == 1 %}
           {% if plot_spectra %}
            <section class="result_section">
                <h5>Reference Spectrum</h5>
                <div class="plot_spectrum_container">
                    {{ plot_spectra|safe }}
                </div>
                                <form id="spectrumIndexForm" action="/get_files_spectra" method="post">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Spectrum Index</span>
                                        <input type="number" id="spectrum_value" name="spectrum_value" value="{{ spectrum_value }}" class="form-control" placeholder="Spectrum index" aria-label="Spectrum value" aria-describedby="button-addon2">
                                        <button class="btn btn-outline-secondary" type="submit">Set</button>
                                    </div>
                                </form>
            </section>
            <section class="result_section2">
                <h5>Merged Reference Spectrum</h5>
                <div class="plot_merge_spectrum_container">
                    {{ plot_merge_spectrum|safe }}
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">Total Merged MS1 Spectra:</span>
                    <input type="number" id="spectrum_value" name="spectrum_value" value="{{ ms_level }}" class="form-control" placeholder="Spectrum value" aria-label="Spectrum value" aria-describedby="button-addon2" disabled>
                </div>
            </section>
            {% endif %}
        {% endif %}
        {% if ms_type == 2 %}
            {% if plot_ms2_spectra %}
            <section class="result_section3">
                <h5>MS1 and MS2 Comparison</h5>
                <div class="plot_spectrum_container">
                    {{ plot_ms2_spectra|safe }}
                </div>
            </section>
            {% endif %}
            {% if plot_ms2_overlay %}
            <section class="result_section4">
                <h5>MS1 and MS2 Normalized Intensity</h5>
                <div class="plot_spectrum_container">
                    {{ plot_ms2_overlay|safe }}
                </div>
            </section>
            {% endif %}
        {% endif %}
    </div>
    <script>
        window.targetDir = 'uploads/spectra';
        window.showProcessingSpinner = function() {
            document.getElementById('processingOverlay').style.display = 'flex';
        };

        // AJAX para el formulario de Spectrum Index
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.getElementById('spectrumIndexForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    window.showProcessingSpinner();
                    var formData = new FormData(form);
                    fetch('/get_files_spectra', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.text())
                    .then(html => {
                        document.open();
                        document.write(html);
                        document.close();
                    });
                });
            }
        });
    </script>
{% endblock %}
